{
  "kind": "build_request",
  "title": "Activity 2: Add upgrade-safe, migration-driven persistence for wallet-domain state",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "In `backend/main.mo`, implement canister upgrade lifecycle plumbing (`system func preupgrade` / `system func postupgrade`) so that wallet-domain state is persisted across upgrades and routed through `migration.run(...)` during upgrade, without changing or breaking any existing public APIs unrelated to migration (e.g., RBAC, user profile, organization, Stripe endpoints must remain compatible).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` defines stable storage for the wallet-domain state that is written in `preupgrade` and restored in `postupgrade`.",
        "`postupgrade` invokes `migration.run(...)` to convert pre-upgrade wallet-domain state into the current wallet-domain state shape.",
        "All existing public methods in `backend/main.mo` unrelated to migration still compile and behave as before (no signature changes, no removed endpoints)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure `backend/migration.mo` exists and exports a stable `run(...)` entrypoint used by `backend/main.mo` during upgrades, where `run(...)` accepts the pre-upgrade (legacy) wallet-domain state and returns the post-migration (organization-scoped) wallet-domain state in a way that is forward-compatible for subsequent Activity 2 steps.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/migration.mo` exports `run(...)` and the project compiles with `backend/main.mo` calling it during upgrade restoration.",
        "`run(...)` is safe to execute on both (a) empty/fresh state and (b) existing state, producing a valid post-migration wallet-domain state in both cases.",
        "The migration interface is version-tolerant/forward-compatible (e.g., includes explicit versioning or a structure that can be extended in later Activity 2 steps without breaking the upgrade path)."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor with all logic in `backend/main.mo`.",
    "Do not change or break existing public APIs unrelated to migration (RBAC, profile, organization, Stripe).",
    "Only introduce or modify `backend/migration.mo` if required for upgrade compatibility."
  ],
  "nonGoals": [
    "Implementing full wallet/transaction CRUD APIs or wiring wallet UI to real backend data (beyond what is required to persist/migrate wallet-domain state).",
    "Adding new third-party services, databases, or backend microservices.",
    "Changing any files under frontend immutable paths listed in SYSTEM_CONTEXT."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}