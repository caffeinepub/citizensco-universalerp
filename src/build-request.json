{
  "kind": "build_request",
  "title": "Activity 2: Wire wallet-domain migration scaffold into canister upgrade lifecycle",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Implement the next step of Activity 2 by wiring upgrade lifecycle plumbing into `backend/main.mo` so wallet-domain state can be persisted across canister upgrades and routed through `migration.run(...)` during upgrade, without changing or breaking existing public APIs unrelated to migration.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to the next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` defines `system preupgrade` and `system postupgrade` hooks (or equivalent upgrade wiring supported by the project) that persist and restore wallet-domain state.",
        "During `postupgrade`, the code calls `migration.run(...)` and uses its output as the post-migration wallet-domain state (even if the state is currently empty/no-op).",
        "Existing non-migration public methods keep the same signatures and continue to compile and deploy."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure `backend/migration.mo` exists and exports a stable `run(...)` entrypoint used by `backend/main.mo` during upgrades, where `run(...)` accepts the pre-upgrade (legacy) wallet-domain state and returns the post-migration (organization-scoped) wallet-domain state in a way that is forward-compatible for subsequent Activity 2 steps.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to the next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/migration.mo` compiles and exports `run(...)` with a stable signature intended for future Activity 2 migration steps.",
        "`backend/main.mo` imports and invokes `migration.run(...)` during upgrade restoration.",
        "A canister upgrade path exists where wallet-domain state is round-tripped through stable memory (preupgrade -> migration.run -> postupgrade) without trapping."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single-actor architecture with all Motoko logic living in `backend/main.mo` (except the migration helper module in `backend/migration.mo`).",
    "Do not introduce additional backend services, databases, or external persistence.",
    "Do not modify frontend immutable paths listed in SYSTEM_CONTEXT."
  ],
  "nonGoals": [
    "Implementing full wallet/transaction CRUD APIs or frontend wallet/transaction UI wiring in this step (only upgrade/migration plumbing).",
    "Changing existing public APIs unrelated to canister upgrade migration."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}