{
  "kind": "build_request",
  "title": "Activity 2: Implement backend canister upgrade migration plumbing for wallet-domain state",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "In `backend/main.mo`, implement correct canister upgrade lifecycle plumbing (`system func preupgrade` / `system func postupgrade`) to persist the wallet-domain stable state across upgrades and route it through `Migration.run(...)` during upgrade, while keeping all existing public APIs (RBAC, user profile, organization, Stripe, and all existing method signatures) backward-compatible.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to the next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` compiles successfully and includes the required `Migration` module reference/import used by `postupgrade`.",
        "On upgrade, wallet-domain stable variables are migrated by calling `Migration.run(preUpgradeState)` and writing the returned state back into the stable variables.",
        "No unrelated public methods (e.g., `getCallerUserProfile`, `saveCallerUserProfile`, `getOrganization`, Stripe endpoints) have breaking signature changes."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Add/ensure `backend/migration.mo` exists and exports a stable `run(...)` entrypoint that accepts the pre-upgrade wallet-domain state (wallets, walletTransactions, walletEvents) and returns the post-migration wallet-domain state in a forward-compatible structure suitable for subsequent Activity 2 organization-scoping steps.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4"
        ],
        "quotes": [
          "Yes to the next step of Activity 2"
        ]
      },
      "acceptanceCriteria": [
        "`backend/migration.mo` is present at exactly `backend/migration.mo` and exports `run(...)`.",
        "`run(...)` typechecks against the state shape used by `backend/main.mo` during `postupgrade`.",
        "The migration implementation is safe to run multiple times without trapping (idempotent or otherwise backward-safe for repeated upgrades)."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor; keep all business logic in `backend/main.mo` (use `backend/migration.mo` only for migration logic).",
    "Do not introduce additional backend services or external databases.",
    "Use English for any user-facing text."
  ],
  "nonGoals": [
    "Implementing full CRUD APIs for wallets/transactions/events beyond what is required for upgrade persistence/migration.",
    "Implementing organization listing/membership APIs or wiring the frontend organization switcher end-to-end.",
    "Fixing existing Stripe request body encoding issues unless directly required by the migration work."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}